<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <script
            src="https://unpkg.com/htmx.org@1.8.0"
            integrity="sha384-cZuAZ+ZbwkNRnrKi05G/fjBX+azI9DNOkNYysZ0I/X5ZFgsmMiBXgDZof30F5ofc"
            crossorigin="anonymous"
        ></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css"
        />
    </head>
    <body>
        <script>
            document.body.addEventListener(
                "htmx:responseError",
                function (evt) {
                    const targetError =
                        evt.target.attributes.getNamedItem("hx-target-error");

                    if (targetError) {
                        document.getElementById(
                            targetError.value,
                        ).innerHTML = `${evt.detail.xhr.status} ${evt.detail.xhr.responseText}`;
                    }
                },
            );

            // Get X-CSRF-Token from POST /login request and store it in Local Storage
            document.body.addEventListener("htmx:afterRequest", function (evt) {
                const url = new URL(evt.detail.xhr.responseURL);
                if (url.pathname === "/login") {
                    const csrfToken =
                        evt.detail.xhr.getResponseHeader("X-CSRF-Token");
                    localStorage.setItem("csrf-token", csrfToken);
                }
            });
        </script>
        <main>
            <div>
                <h2>Login</h2>
                <form
                    hx-post="/login"
                    hx-target="this"
                    hx-target-error="login-div"
                >
                    <div>
                        <label>Email</label>
                        <input name="email" type="email" required />
                    </div>
                    <div>
                        <label>Password</label>
                        <input name="password" type="password" required />
                    </div>
                    <div>
                        <button type="submit">Login</button>
                    </div>
                </form>
                <div id="login-div"></div>
            </div>

            <hr />
            <div>
                <h2>Make an authenticated request</h2>
                <button
                    hx-get="/hello"
                    hx-target="#hello"
                    hx-target-error="hello"
                    hx-headers="javascript:{'X-CSRF-Token': localStorage.getItem('csrf-token')}"
                >
                    Hello
                </button>
                <div id="hello"></div>
            </div>
            <hr />
            <div>
                <h2>Clear cookies</h2>
                <button hx-post="/logout" hx-target="#logout">Logout</button>
                <div id="logout"></div>
            </div>
        </main>
        <hr />
        <footer>
            Don't have an account? <a href="/register">Register here.</a>
        </footer>
    </body>
</html>
